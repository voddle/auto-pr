#!/usr/bin/env bash
set -euo pipefail

# ── Detect gh CLI ──────────────────────────────────────────────
GH=""
if command -v gh &>/dev/null; then
  GH="gh"
elif [ -x "/c/Program Files/GitHub CLI/gh.exe" ]; then
  GH="/c/Program Files/GitHub CLI/gh.exe"
elif [ -x "/mnt/c/Program Files/GitHub CLI/gh.exe" ]; then
  GH="/mnt/c/Program Files/GitHub CLI/gh.exe"
else
  echo "Error: gh CLI not found. Install from https://cli.github.com" >&2
  exit 1
fi

# ── Parse arguments ────────────────────────────────────────────
PR_NUMBER=""
LATEST_ONLY=false
JSON_OUTPUT=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    --latest)  LATEST_ONLY=true; shift ;;
    --json)    JSON_OUTPUT=true; shift ;;
    --help|-h)
      echo "Usage: pr-reviews [PR_NUMBER] [--latest] [--json]"
      echo ""
      echo "  pr-reviews          Auto-detect PR for current branch"
      echo "  pr-reviews 123      Show reviews for PR #123"
      echo "  pr-reviews --latest Only show the latest review round"
      echo "  pr-reviews --json   Raw JSON output"
      exit 0
      ;;
    *)
      if [[ "$1" =~ ^[0-9]+$ ]]; then
        PR_NUMBER="$1"
      else
        echo "Error: Unknown argument '$1'" >&2
        exit 1
      fi
      shift
      ;;
  esac
done

# ── Resolve repo slug ─────────────────────────────────────────
REPO=$("$GH" repo view --json nameWithOwner --jq '.nameWithOwner' 2>/dev/null) || {
  echo "Error: Not inside a GitHub repository." >&2
  exit 1
}

# ── Resolve PR number ─────────────────────────────────────────
if [[ -z "$PR_NUMBER" ]]; then
  BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null) || {
    echo "Error: Not inside a git repository." >&2
    exit 1
  }
  PR_NUMBER=$("$GH" api "repos/${REPO}/pulls" \
    --jq ".[] | select(.head.ref==\"${BRANCH}\") | .number" 2>/dev/null | head -1)
  if [[ -z "$PR_NUMBER" ]]; then
    echo "Error: No open PR found for branch '${BRANCH}'." >&2
    exit 1
  fi
  echo "Detected PR #${PR_NUMBER} for branch '${BRANCH}'"
fi

# ── Fetch review comments (line-level) ────────────────────────
COMMENTS=$("$GH" api "repos/${REPO}/pulls/${PR_NUMBER}/comments" \
  --paginate 2>/dev/null) || {
  echo "Error: Failed to fetch review comments." >&2
  exit 1
}

# ── Fetch top-level reviews ───────────────────────────────────
REVIEWS=$("$GH" api "repos/${REPO}/pulls/${PR_NUMBER}/reviews" \
  --paginate 2>/dev/null) || {
  echo "Error: Failed to fetch reviews." >&2
  exit 1
}

# ── Raw JSON mode ─────────────────────────────────────────────
if $JSON_OUTPUT; then
  echo '{"reviews":'
  echo "$REVIEWS"
  echo ',"comments":'
  echo "$COMMENTS"
  echo '}'
  exit 0
fi

# ── Filter latest round if requested ─────────────────────────
if $LATEST_ONLY; then
  LATEST_ID=$(echo "$REVIEWS" | "$GH" api --input - \
    --jq 'if type=="array" then . else [.] end | map(.id) | max // empty' 2>/dev/null || true)

  if [[ -n "$LATEST_ID" ]]; then
    REVIEWS=$(echo "$REVIEWS" | "$GH" api --input - \
      --jq "if type==\"array\" then . else [.] end | map(select(.id==${LATEST_ID}))" 2>/dev/null)
    COMMENTS=$(echo "$COMMENTS" | "$GH" api --input - \
      --jq "if type==\"array\" then . else [.] end | map(select(.pull_request_review_id==${LATEST_ID}))" 2>/dev/null)
  fi
fi

# ── Pretty-print reviews ─────────────────────────────────────
echo ""
echo "═══ PR #${PR_NUMBER} Reviews ═══"
echo ""

# Top-level reviews (APPROVED / CHANGES_REQUESTED / COMMENTED)
echo "$REVIEWS" | "$GH" api --input - \
  --jq 'if type=="array" then . else [.] end | .[] |
    select(.body != "" or .state != "COMMENTED") |
    "── \(.state) by @\(.user.login) (\(.submitted_at // "pending")) ──\n\(.body)\n"' 2>/dev/null || true

# Line-level comments
COMMENT_COUNT=$(echo "$COMMENTS" | "$GH" api --input - \
  --jq 'if type=="array" then . else [.] end | length' 2>/dev/null || echo "0")

if [[ "$COMMENT_COUNT" -gt 0 ]]; then
  echo "── Inline Comments (${COMMENT_COUNT}) ──"
  echo ""
  echo "$COMMENTS" | "$GH" api --input - \
    --jq 'if type=="array" then . else [.] end | .[] |
      "  \(.path):\(.line // .original_line // "?")  @\(.user.login)\n  \(.body)\n  ID: \(.id)\n"' 2>/dev/null || true
fi

echo "Done."
