#!/usr/bin/env bash
set -euo pipefail

# ── Usage ──────────────────────────────────────────────────────
usage() {
  echo "Usage:"
  echo "  pr-reply <comment_id> \"reply body\"   Reply to a review comment"
  echo "  pr-reply --list [PR_NUMBER]           List comment IDs available for reply"
  echo "  pr-reply --help                       Show this help"
}

# ── Early exit for help / no args ─────────────────────────────
if [[ $# -eq 0 ]]; then
  usage
  exit 1
fi
if [[ "$1" == "--help" || "$1" == "-h" ]]; then
  usage
  exit 0
fi

# ── Detect gh CLI ──────────────────────────────────────────────
GH=""
if command -v gh &>/dev/null; then
  GH="gh"
elif [ -x "/c/Program Files/GitHub CLI/gh.exe" ]; then
  GH="/c/Program Files/GitHub CLI/gh.exe"
elif [ -x "/mnt/c/Program Files/GitHub CLI/gh.exe" ]; then
  GH="/mnt/c/Program Files/GitHub CLI/gh.exe"
else
  echo "Error: gh CLI not found. Install from https://cli.github.com" >&2
  exit 1
fi

# ── Resolve repo slug ─────────────────────────────────────────
REPO=$("$GH" repo view --json nameWithOwner --jq '.nameWithOwner' 2>/dev/null) || {
  echo "Error: Not inside a GitHub repository." >&2
  exit 1
}

# ── Resolve PR number from current branch ─────────────────────
resolve_pr() {
  local branch
  branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null) || {
    echo "Error: Not inside a git repository." >&2
    exit 1
  }
  local pr
  pr=$("$GH" api "repos/${REPO}/pulls" \
    --jq ".[] | select(.head.ref==\"${branch}\") | .number" 2>/dev/null | head -1)
  if [[ -z "$pr" ]]; then
    echo "Error: No open PR found for branch '${branch}'." >&2
    exit 1
  fi
  echo "$pr"
}

# ── --list mode ────────────────────────────────────────────────
list_comments() {
  local pr_number="${1:-}"
  if [[ -z "$pr_number" ]]; then
    pr_number=$(resolve_pr)
  fi
  echo "Comments on PR #${pr_number} that can be replied to:"
  echo ""
  "$GH" api "repos/${REPO}/pulls/${pr_number}/comments" --paginate \
    --jq '.[] | "  ID: \(.id)  @\(.user.login)  \(.path):\(.line // .original_line // "?")\n  \(.body | split("\n") | first)\n"' 2>/dev/null || {
    echo "Error: Failed to fetch comments." >&2
    exit 1
  }
}

# ── Dispatch ──────────────────────────────────────────────────
case "$1" in
  --list)
    list_comments "${2:-}"
    exit 0
    ;;
  *)
    # Expect: pr-reply <comment_id> "body"
    if [[ $# -lt 2 ]]; then
      echo "Error: Missing reply body." >&2
      echo "Usage: pr-reply <comment_id> \"reply body\"" >&2
      exit 1
    fi

    COMMENT_ID="$1"
    REPLY_BODY="$2"

    if ! [[ "$COMMENT_ID" =~ ^[0-9]+$ ]]; then
      echo "Error: comment_id must be a number, got '${COMMENT_ID}'." >&2
      exit 1
    fi

    # Post reply using the review comment reply endpoint
    "$GH" api "repos/${REPO}/pulls/comments/${COMMENT_ID}/replies" \
      -f body="$REPLY_BODY" \
      --jq '"Reply posted (ID: \(.id)) by @\(.user.login)"' 2>/dev/null || {
      echo "Error: Failed to post reply. Check comment ID and permissions." >&2
      exit 1
    }
    ;;
esac
